<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Budget Buckets App</title>
  <link rel="icon" type="image/jpeg" href="favicon.jpg" />

  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    function App() {
      // ---------------- Utils ----------------
      const round2 = (n) => Math.round((Number(n) || 0) * 100) / 100;
      const currency = (n) => `$${round2(n).toFixed(2)}`;
      const pad2 = (n) => String(n).padStart(2, "0");
      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

      const fmtDate = (d) => {
        const date = new Date(d);
        return `${date.getFullYear()}-${pad2(date.getMonth() + 1)}-${pad2(date.getDate())}`;
      };

      // Parse YYYY-MM-DD -> local midnight Date (prevents UTC drift)
      const parseYMDLocal = (ymd) => {
        if (!ymd || !/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return null;
        const [y, m, d] = ymd.split("-").map(Number);
        return new Date(y, m - 1, d, 0, 0, 0, 0);
      };

      const floorLocalToday = () => {
        const n = new Date();
        return new Date(n.getFullYear(), n.getMonth(), n.getDate(), 0, 0, 0, 0);
      };

      const niceDate = (ymd) => {
        const d = parseYMDLocal(ymd);
        if (!d) return ymd || "";
        return d.toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" });
      };

      const loadState = (key, fallback) => {
        try {
          const stored = localStorage.getItem(key);
          if (stored) return JSON.parse(stored);
        } catch (e) {}
        return fallback;
      };

      // Safe money parsing: parse only on save/add
      const parseMoney = (s) => {
        const cleaned = String(s ?? "")
          .replace(/[^0-9.\-]/g, "")
          .replace(/(?!^)-/g, ""); // only allow leading minus
        const val = parseFloat(cleaned);
        return Number.isFinite(val) ? round2(val) : 0;
      };

      // ---------------- Initial State ----------------
      const [buckets, setBuckets] = React.useState(
        loadState("buckets", [
          { id: 1, name: "Out to Eat", budgeted: 150, spent: 0, period: "weekly" },
          { id: 2, name: "Groceries", budgeted: 400, spent: 0, period: "monthly" },
        ])
      );

      // frequencies: monthly | weekly | biweekly | once
      const [recurringIncome, setRecurringIncome] = React.useState(
        loadState("recurringIncome", [
          { id: 1, name: "Salary", amount: 3000, frequency: "monthly", nextDate: "2025-10-01" },
          { id: 2, name: "Side Hustle", amount: 500, frequency: "weekly", nextDate: "2025-10-03" },
        ])
      );

      // bills: monthly (dueDay), weekly (nextDate anchor), yearly (dueMonth 1-12 + dueDay)
      const [recurringBills, setRecurringBills] = React.useState(
        loadState("recurringBills", [
          { id: 1, name: "Rent", amount: 1200, frequency: "monthly", dueDay: 1 },
          { id: 2, name: "Phone", amount: 80, frequency: "monthly", dueDay: 15 },
          { id: 3, name: "Car Insurance", amount: 600, frequency: "yearly", dueMonth: 6, dueDay: 15 },
        ])
      );

      const [transactions, setTransactions] = React.useState(loadState("transactions", []));
      const [activeTab, setActiveTab] = React.useState("summary");

      const today = new Date();
      const [selectedMonth, setSelectedMonth] = React.useState(loadState("selectedMonth", today.getMonth()));
      const [selectedYear, setSelectedYear] = React.useState(loadState("selectedYear", today.getFullYear()));

      // ---------------- Persist ----------------
      React.useEffect(() => localStorage.setItem("buckets", JSON.stringify(buckets)), [buckets]);
      React.useEffect(() => localStorage.setItem("recurringIncome", JSON.stringify(recurringIncome)), [recurringIncome]);
      React.useEffect(() => localStorage.setItem("recurringBills", JSON.stringify(recurringBills)), [recurringBills]);
      React.useEffect(() => localStorage.setItem("transactions", JSON.stringify(transactions)), [transactions]);
      React.useEffect(() => localStorage.setItem("selectedMonth", JSON.stringify(selectedMonth)), [selectedMonth]);
      React.useEffect(() => localStorage.setItem("selectedYear", JSON.stringify(selectedYear)), [selectedYear]);

      // ---------------- Reset logic (NEVER delete transactions) ----------------
      React.useEffect(() => {
        const now = new Date();
        const lastSeen = localStorage.getItem("lastSeenMonth");
        const current = `${now.getFullYear()}-${now.getMonth() + 1}`;
        if (!lastSeen) {
          localStorage.setItem("lastSeenMonth", current);
          return;
        }
        if (lastSeen !== current && now.getDate() === 1) {
          setBuckets((prev) => prev.map((b) => ({ ...b, spent: 0 })));
          localStorage.setItem("lastSeenMonth", current);
        }
      }, []);

      React.useEffect(() => {
        const now = new Date();
        const isMonday = now.getDay() === 1;
        if (!isMonday) return;

        const getISOWeek = (d) => {
          const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
          const dayNum = date.getUTCDay() || 7;
          date.setUTCDate(date.getUTCDate() + 4 - dayNum);
          const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
          return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
        };

        const currentWeek = `${now.getFullYear()}-W${getISOWeek(now)}`;
        const lastSeenWeek = localStorage.getItem("lastSeenWeek");
        if (lastSeenWeek !== currentWeek) {
          setBuckets((prev) => prev.map((b) => (b.period === "weekly" ? { ...b, spent: 0 } : b)));
          localStorage.setItem("lastSeenWeek", currentWeek);
        }
      }, []);

      // ---------------- Calendar ----------------
      const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
      const monthKey = `${selectedYear}-${pad2(selectedMonth + 1)}`;
      const monthStart = new Date(selectedYear, selectedMonth, 1, 0, 0, 0, 0);
      const monthEnd = new Date(selectedYear, selectedMonth, daysInMonth, 23, 59, 59, 999);

      // ---------------- Next due date (weekday-safe) ----------------
      const nextSingleDueDate = (item) => {
        const today0 = floorLocalToday();

        if (item.frequency === "once") {
          const d = parseYMDLocal(item.nextDate);
          return d ? fmtDate(d) : "";
        }

        if (item.frequency === "weekly" || item.frequency === "biweekly") {
          const intervalDays = item.frequency === "weekly" ? 7 : 14;
          const anchor = parseYMDLocal(item.nextDate) || today0;
          let cand = new Date(anchor);
          while (cand <= today0) cand.setDate(cand.getDate() + intervalDays);
          return fmtDate(cand);
        }

        if (item.frequency === "monthly") {
          let day = item.dueDay ?? (parseYMDLocal(item.nextDate)?.getDate() ?? 1);
          day = clamp(day, 1, 28);
          let cand = new Date(today0.getFullYear(), today0.getMonth(), day, 0, 0, 0, 0);
          if (cand <= today0) cand = new Date(today0.getFullYear(), today0.getMonth() + 1, day, 0, 0, 0, 0);
          return fmtDate(cand);
        }

        if (item.frequency === "yearly") {
          const month1to12 = item.dueMonth ?? 1;
          const month0to11 = clamp(month1to12, 1, 12) - 1;
          const day = clamp(item.dueDay ?? 1, 1, 28);
          let cand = new Date(today0.getFullYear(), month0to11, day, 0, 0, 0, 0);
          if (cand <= today0) cand = new Date(today0.getFullYear() + 1, month0to11, day, 0, 0, 0, 0);
          return fmtDate(cand);
        }

        return item.nextDate || fmtDate(today0);
      };

      // ---------------- Custom week start (based on biggest repeating income‚Äôs next weekday) ----------------
      const incomeMonthlyValueLegacy = (i) => {
        const amt = Number(i.amount) || 0;
        if (i.frequency === "weekly") return amt * 4;
        if (i.frequency === "biweekly") return amt * 2;
        if (i.frequency === "monthly") return amt;
        return 0;
      };

      let weekStartDay = 1; // Monday default
      let weekStartLabel = "Monday";

      const repeatingIncomes = recurringIncome.filter(i => i.frequency !== "once");
      if (repeatingIncomes.length) {
        let maxIncome = repeatingIncomes[0];
        let maxValue = incomeMonthlyValueLegacy(maxIncome);
        for (let i = 1; i < repeatingIncomes.length; i++) {
          const val = incomeMonthlyValueLegacy(repeatingIncomes[i]);
          if (val > maxValue) { maxIncome = repeatingIncomes[i]; maxValue = val; }
        }
        const nextDue = parseYMDLocal(nextSingleDueDate(maxIncome)) || new Date();
        weekStartDay = nextDue.getDay();
        weekStartLabel = nextDue.toLocaleDateString("en-US", { weekday: "long" });
      }

      const getLastCustomWeekStart = (d) => {
        const date = new Date(d);
        date.setHours(0, 0, 0, 0);
        const day = date.getDay();
        const diff = (day >= weekStartDay) ? (day - weekStartDay) : (7 - (weekStartDay - day));
        date.setDate(date.getDate() - diff);
        return date;
      };

      const getEndOfCustomWeek = (d) => {
        const start = getLastCustomWeekStart(d);
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        end.setHours(23, 59, 59, 999);
        return end;
      };

      const countCustomWeeksInMonth = () => {
        const start = new Date(monthStart); start.setHours(0,0,0,0);
        const end = new Date(monthEnd); end.setHours(23,59,59,999);

        let first = getLastCustomWeekStart(start);
        let count = 0;

        while (first <= end) {
          if (first >= start && first <= end) count++;
          first = new Date(first);
          first.setDate(first.getDate() + 7);
          first.setHours(0,0,0,0);
        }
        return Math.max(1, count || 4);
      };

      const now = new Date();
      const weekStart = getLastCustomWeekStart(now);
      const weekEnd = getEndOfCustomWeek(now);

      // ---------------- Spent derived from transactions ----------------
      const bucketsWithSpent = buckets.map((b) => {
        if (b.period === "weekly") {
          const spent = transactions
            .filter((t) => {
              const txDate = parseYMDLocal(t.date);
              return t.bucketId === b.id && txDate && txDate >= weekStart && txDate <= weekEnd;
            })
            .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
          return { ...b, spent: round2(spent) };
        }

        const spent = transactions
          .filter((t) => {
            const txDate = parseYMDLocal(t.date);
            return t.bucketId === b.id && txDate && txDate >= monthStart && txDate <= monthEnd;
          })
          .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);

        return { ...b, spent: round2(spent) };
      });

      const totalMonthlySpent = bucketsWithSpent.reduce((s, b) => s + (Number(b.spent) || 0), 0);

      // ---------------- Occurrence counting (month-accurate paydays) ----------------
      const isInRange = (d, start, end) => d >= start && d <= end;

      const countOccurrencesInSelectedMonth = (item) => {
        const start = new Date(monthStart); start.setHours(0,0,0,0);
        const end = new Date(monthEnd); end.setHours(23,59,59,999);

        if (item.frequency === "weekly" || item.frequency === "biweekly") {
          const step = item.frequency === "weekly" ? 7 : 14;
          const anchor = parseYMDLocal(item.nextDate);
          if (!anchor) return 0;

          let d = new Date(anchor); d.setHours(0,0,0,0);

          while (d > start) d.setDate(d.getDate() - step);
          while (d < start) d.setDate(d.getDate() + step);

          let count = 0;
          while (d <= end) {
            count++;
            d.setDate(d.getDate() + step);
          }
          return count;
        }

        if (item.frequency === "monthly") return 1;

        if (item.frequency === "once") {
          const d = parseYMDLocal(item.nextDate);
          return d && isInRange(d, start, end) ? 1 : 0;
        }

        return 0;
      };

      // ---------------- Monthly math ----------------
      const monthlyFromBudget = (b) => {
        const w = countCustomWeeksInMonth();
        return b.period === "weekly" ? round2((b.budgeted || 0) * w) : round2(b.budgeted || 0);
      };

      const monthlyFromIncome = (i) => {
        if (i.frequency === "weekly" || i.frequency === "biweekly") {
          const count = countOccurrencesInSelectedMonth(i);
          return round2((i.amount || 0) * count);
        }
        if (i.frequency === "once") return countOccurrencesInSelectedMonth(i) ? round2(i.amount || 0) : 0;
        return round2(i.amount || 0);
      };

      // (kept for other areas; not used as the "Bills (month)" on summary anymore)
      const monthlyFromBill = (b) => {
        if (b.frequency === "weekly") {
          const count = countOccurrencesInSelectedMonth({ ...b, frequency: "weekly" });
          return round2((b.amount || 0) * count);
        }
        if (b.frequency === "yearly") return round2((b.amount || 0) / 12);
        return round2(b.amount || 0);
      };

      const totalMonthlyIncome = recurringIncome.reduce((s, i) => s + monthlyFromIncome(i), 0);
      const totalMonthlyBills_EST = recurringBills.reduce((s, b) => s + monthlyFromBill(b), 0); // legacy/extra info if needed
      const totalMonthlyBudgeted = buckets.reduce((s, b) => s + monthlyFromBudget(b), 0);

      // ---------------- Main paycheck + paydays count ----------------
      const getMainPaycheck = () => {
        const repeating = recurringIncome.filter(i => i.frequency !== "once");
        if (!repeating.length) return null;

        const score = (i) => {
          const amt = Number(i.amount) || 0;
          if (i.frequency === "weekly" || i.frequency === "biweekly") return monthlyFromIncome(i);
          if (i.frequency === "monthly") return amt;
          return 0;
        };

        return repeating.reduce((best, cur) => (score(cur) > score(best) ? cur : best), repeating[0]);
      };

      const countPaydaysInSelectedMonth = () => {
        const main = getMainPaycheck();
        if (!main) return 0;
        if (main.frequency === "weekly" || main.frequency === "biweekly") return countOccurrencesInSelectedMonth(main);
        if (main.frequency === "monthly") return 1;
        return 0;
      };

      const mainPaycheck = getMainPaycheck();
      const paydaysThisMonthRaw = countPaydaysInSelectedMonth();
      const usedFallbackPaydays = paydaysThisMonthRaw <= 0;
      const paydaysThisMonth = usedFallbackPaydays ? 4 : paydaysThisMonthRaw;

      // ---------------- Weekly cashflow: this + next ----------------
      const addDays = (d, n) => {
        const x = new Date(d);
        x.setDate(x.getDate() + n);
        return x;
      };

      const thisWeekStart = new Date(weekStart); thisWeekStart.setHours(0,0,0,0);
      const thisWeekEnd = new Date(weekEnd); thisWeekEnd.setHours(23,59,59,999);
      const nextWeekStart = addDays(thisWeekStart, 7); nextWeekStart.setHours(0,0,0,0);
      const nextWeekEnd = addDays(nextWeekStart, 6); nextWeekEnd.setHours(23,59,59,999);

      const listOccurrencesInRange = (item, kind, rangeStart, rangeEnd) => {
        const out = [];
        const start = new Date(rangeStart); start.setHours(0,0,0,0);
        const end = new Date(rangeEnd); end.setHours(23,59,59,999);

        const name = item.name || (kind === "income" ? "Income" : "Bill");
        const amount = round2(item.amount || 0);

        if (item.frequency === "once") {
          const d = parseYMDLocal(item.nextDate);
          if (d && d >= start && d <= end) {
            out.push({ type: kind, sourceId: item.id, id: `${kind}-${item.id}-${fmtDate(d)}`, name, amount, frequency: item.frequency, date: fmtDate(d) });
          }
          return out;
        }

        if (item.frequency === "weekly" || item.frequency === "biweekly") {
          const step = item.frequency === "weekly" ? 7 : 14;
          const anchor = parseYMDLocal(item.nextDate);
          if (!anchor) return out;

          let d = new Date(anchor); d.setHours(0,0,0,0);
          while (d > start) d = addDays(d, -step);
          while (d < start) d = addDays(d, step);

          while (d <= end) {
            out.push({ type: kind, sourceId: item.id, id: `${kind}-${item.id}-${fmtDate(d)}`, name, amount, frequency: item.frequency, date: fmtDate(d) });
            d = addDays(d, step);
          }
          return out;
        }

        if (item.frequency === "monthly") {
          const anchor = parseYMDLocal(item.nextDate);
          const day = clamp(anchor ? anchor.getDate() : (item.dueDay ?? 1), 1, 28);
          const d = new Date(start.getFullYear(), start.getMonth(), day, 0,0,0,0);
          if (d >= start && d <= end) out.push({ type: kind, sourceId: item.id, id: `${kind}-${item.id}-${fmtDate(d)}`, name, amount, frequency: item.frequency, date: fmtDate(d) });
          return out;
        }

        if (item.frequency === "yearly") {
          const month0 = clamp(item.dueMonth ?? 1, 1, 12) - 1;
          const day = clamp(item.dueDay ?? 1, 1, 28);
          const d = new Date(start.getFullYear(), month0, day, 0,0,0,0);
          if (d >= start && d <= end) out.push({ type: kind, sourceId: item.id, id: `${kind}-${item.id}-${fmtDate(d)}`, name, amount, frequency: item.frequency, date: fmtDate(d) });
          return out;
        }

        const ymd = nextSingleDueDate(item);
        const d = parseYMDLocal(ymd);
        if (d && d >= start && d <= end) out.push({ type: kind, sourceId: item.id, id: `${kind}-${item.id}-${ymd}`, name, amount, frequency: item.frequency, date: ymd });
        return out;
      };

      const weekEvents = (rangeStart, rangeEnd) => {
        const items = [];
        recurringIncome.forEach(i => items.push(...listOccurrencesInRange(i, "income", rangeStart, rangeEnd)));
        recurringBills.forEach(b => items.push(...listOccurrencesInRange(b, "bill", rangeStart, rangeEnd)));
        return items.sort((a,b) => (a.date > b.date ? 1 : -1) || (a.type > b.type ? 1 : -1));
      };

      const totalsForEvents = (arr) => {
        const income = round2(arr.filter(x => x.type === "income").reduce((s,x) => s + x.amount, 0));
        const bills  = round2(arr.filter(x => x.type === "bill").reduce((s,x) => s + x.amount, 0));
        return { income, bills, leftover: round2(income - bills) };
      };

      const thisWeekEvents = weekEvents(thisWeekStart, thisWeekEnd);
      const nextWeekEvents = weekEvents(nextWeekStart, nextWeekEnd);
      const thisWeekTotals = totalsForEvents(thisWeekEvents);
      const nextWeekTotals = totalsForEvents(nextWeekEvents);

      // ---------------- Bills due this month (ACTUAL) + per-paycheck (simple) ----------------
      const monthBills = [];
      recurringBills.forEach(b => monthBills.push(...listOccurrencesInRange(b, "bill", monthStart, monthEnd)));
      const totalBillsDueThisMonth = round2(monthBills.reduce((s, x) => s + (x.amount || 0), 0));

      const perPaycheckSetAsideForBills = round2(
        totalBillsDueThisMonth / Math.max(1, paydaysThisMonth)
      );

      // ---------------- Warnings ----------------
      const isMissingAnchorIncome = (i) => (i.frequency === "weekly" || i.frequency === "biweekly") && !parseYMDLocal(i.nextDate);
      const isMissingAnchorBill = (b) => (b.frequency === "weekly") && !parseYMDLocal(b.nextDate);
      const isMissingDateOnceIncome = (i) => (i.frequency === "once") && !parseYMDLocal(i.nextDate);

      const missingIncomeAnchors = recurringIncome.filter(isMissingAnchorIncome);
      const missingBillAnchors = recurringBills.filter(isMissingAnchorBill);
      const missingOnceDates = recurringIncome.filter(isMissingDateOnceIncome);

      const hasAnyAnchorWarnings =
        missingIncomeAnchors.length > 0 ||
        missingBillAnchors.length > 0 ||
        missingOnceDates.length > 0;

      // ---------------- UI helpers ----------------
      const getProgressColor = (spent, budgeted) => {
        const pct = budgeted > 0 ? (spent / budgeted) * 100 : 0;
        if (pct >= 100) return "bg-red-500";
        if (pct >= 80) return "bg-yellow-500";
        return "bg-green-500";
      };

      const Pill = ({ children, className="" }) => (
        <span className={`inline-flex items-center text-xs px-2 py-1 rounded-full border ${className}`}>
          {children}
        </span>
      );

      const WarnPill = ({ text }) => (
        <span className="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full border bg-amber-50 text-amber-800 border-amber-200">
          ‚ö†Ô∏è {text}
        </span>
      );

      const StatCard = ({ label, value, sub, tone="slate" }) => {
        const toneMap = {
          slate: "text-slate-800",
          emerald: "text-emerald-700",
          rose: "text-rose-700",
          indigo: "text-indigo-700",
        };
        return (
          <div className="bg-white rounded-2xl shadow p-4 border border-slate-100">
            <div className="text-xs uppercase tracking-wide text-slate-500">{label}</div>
            <div className={`text-2xl font-extrabold mt-1 ${toneMap[tone] || "text-slate-800"}`}>{value}</div>
            {sub ? <div className="text-xs text-slate-500 mt-1">{sub}</div> : null}
          </div>
        );
      };

      const Card = ({ children, className="" }) => (
        <div className={`bg-white rounded-2xl shadow border border-slate-100 ${className}`}>{children}</div>
      );

      const Field = ({ label, children }) => (
        <label className="block">
          <div className="text-xs text-slate-600 font-medium mb-1">{label}</div>
          {children}
        </label>
      );

      const inputBase = "border rounded-lg px-2 py-1 text-sm w-full bg-white shadow-sm";
      const moneyInputBase = inputBase + " tabular-nums";
      const buttonBase = "px-3 py-1.5 rounded-lg text-sm font-semibold shadow-sm";
      const btnPrimary = "bg-indigo-600 hover:bg-indigo-700 text-white";
      const btnSoft = "bg-slate-100 hover:bg-slate-200 text-slate-700";
      const btnDanger = "bg-rose-100 hover:bg-rose-200 text-rose-700";

      // =====================================================================
      // ‚úÖ FIX: Uncontrolled refs for ALL typing fields (prevents iOS focus loss)
      // =====================================================================
      const todayStr = fmtDate(new Date());

      const bucketDraftRef = React.useRef(null);
      const incomeDraftRef = React.useRef(null);
      const billDraftRef = React.useRef(null);

      const newBucketRef = React.useRef({ name: "", budgeted: "", period: "monthly" });
      const newIncomeRef = React.useRef({ name: "", amount: "", frequency: "monthly", nextDate: "" });
      const newBillRef = React.useRef({ name: "", amount: "", frequency: "monthly", dueDay: "", dueMonth: "", nextDate: "" });
      const newTxRef = React.useRef({ bucketId: "", amount: "", description: "", date: todayStr });

      const setRefField = (ref, key, value) => {
        ref.current = { ...(ref.current || {}), [key]: value };
      };

      // Keys to force-reset uncontrolled forms after add/save/cancel
      const [bucketFormKey, setBucketFormKey] = React.useState(1);
      const [incomeFormKey, setIncomeFormKey] = React.useState(1);
      const [billFormKey, setBillFormKey] = React.useState(1);
      const [txFormKey, setTxFormKey] = React.useState(1);

      const [editKey, setEditKey] = React.useState(1);

      // ---------------- CRUD: Transactions ----------------
      const addTransaction = () => {
        const d = newTxRef.current || {};
        if (!d.bucketId || !String(d.amount || "").trim() || !String(d.description || "").trim()) return;

        const bucketIdNum = Number(d.bucketId);
        const tx = {
          id: Date.now(),
          bucketId: bucketIdNum,
          amount: parseMoney(d.amount),
          description: String(d.description).trim(),
          date: d.date || todayStr,
        };

        setTransactions((prev) => [...prev, tx]);
        newTxRef.current = { bucketId: "", amount: "", description: "", date: todayStr };
        setTxFormKey(k => k + 1);
      };

      const deleteTransaction = (id) => setTransactions((prev) => prev.filter((t) => t.id !== id));

      // ---------------- CRUD: Buckets ----------------
      const addBucket = () => {
        const d = newBucketRef.current || {};
        if (!String(d.name || "").trim() || !String(d.budgeted || "").trim()) return;

        const b = {
          id: Date.now(),
          name: String(d.name).trim(),
          budgeted: parseMoney(d.budgeted),
          spent: 0,
          period: d.period === "weekly" ? "weekly" : "monthly",
        };
        setBuckets((prev) => [...prev, b]);

        newBucketRef.current = { name: "", budgeted: "", period: "monthly" };
        setBucketFormKey(k => k + 1);
      };

      const deleteBucket = (id) => {
        setBuckets((prev) => prev.filter((b) => b.id !== id));
        setTransactions((prev) => prev.filter((t) => t.bucketId !== id));
      };

      const resetBucket = (id) => {
        setBuckets((prev) => prev.map((b) => (b.id === id ? { ...b, spent: 0 } : b)));
      };

      const updateBucket = (id, patch) => {
        setBuckets(prev => prev.map(b => b.id === id ? { ...b, ...patch } : b));
      };

      // ---------------- CRUD: Income ----------------
      const addIncome = () => {
        const d = newIncomeRef.current || {};
        if (!String(d.name || "").trim() || !String(d.amount || "").trim()) return;
        if (d.frequency === "once" && !parseYMDLocal(d.nextDate)) return;

        setRecurringIncome((prev) => [
          ...prev,
          {
            id: Date.now(),
            name: String(d.name).trim(),
            amount: parseMoney(d.amount),
            frequency: d.frequency || "monthly",
            nextDate: d.nextDate || "",
          }
        ]);

        newIncomeRef.current = { name: "", amount: "", frequency: "monthly", nextDate: "" };
        setIncomeFormKey(k => k + 1);
      };

      const deleteIncome = (id) => setRecurringIncome((prev) => prev.filter((i) => i.id !== id));

      const updateIncome = (id, patch) => {
        setRecurringIncome(prev => prev.map(i => i.id === id ? { ...i, ...patch } : i));
      };

      // ---------------- CRUD: Bills ----------------
      const addBill = () => {
        const d = newBillRef.current || {};
        if (!String(d.name || "").trim() || !String(d.amount || "").trim()) return;

        const bill = {
          id: Date.now(),
          name: String(d.name).trim(),
          amount: parseMoney(d.amount),
          frequency: d.frequency || "monthly",
        };

        if (bill.frequency === "monthly") bill.dueDay = clamp(parseInt(d.dueDay || "1", 10), 1, 28);
        if (bill.frequency === "yearly") {
          bill.dueMonth = clamp(parseInt(d.dueMonth || "1", 10), 1, 12);
          bill.dueDay = clamp(parseInt(d.dueDay || "1", 10), 1, 28);
        }
        if (bill.frequency === "weekly") bill.nextDate = d.nextDate || "";

        setRecurringBills((prev) => [...prev, bill]);

        newBillRef.current = { name: "", amount: "", frequency: "monthly", dueDay: "", dueMonth: "", nextDate: "" };
        setBillFormKey(k => k + 1);
      };

      const deleteBill = (id) => setRecurringBills((prev) => prev.filter((b) => b.id !== id));

      const updateBill = (id, patch) => {
        setRecurringBills(prev => prev.map(b => b.id === id ? { ...b, ...patch } : b));
      };

      // ---------------- Download / Upload (BACKWARDS COMPATIBLE) ----------------
      const JSON_START = "---BEGIN_BUDGET_BUCKETS_JSON---";
      const JSON_END = "---END_BUDGET_BUCKETS_JSON---";

      const downloadDataBackup = () => {
        const label = new Date(selectedYear, selectedMonth).toLocaleDateString("en-US", { month: "long", year: "numeric" });

        const payload = {
          version: 7,
          exportedAt: new Date().toISOString(),
          selectedYear,
          selectedMonth,
          buckets,
          recurringIncome,
          recurringBills,
          transactions,
        };

        let txt = `üìå BUDGET DATA BACKUP ‚Äî ${label}\n`;
        txt += `This file contains ONLY: buckets, recurringIncome, recurringBills, transactions.\n\n`;
        txt += `${JSON_START}\n`;
        txt += JSON.stringify(payload, null, 2);
        txt += `\n${JSON_END}\n`;

        const blob = new Blob([txt], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `budget-backup-${monthKey}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const txKey = (t) =>
        `${t.bucketId}|${t.date}|${round2(t.amount).toFixed(2)}|${String(t.description || "").trim()}`;

      const normalizePayload = (p) => {
        const out = {
          selectedYear: Number.isFinite(Number(p?.selectedYear)) ? Number(p.selectedYear) : selectedYear,
          selectedMonth: Number.isFinite(Number(p?.selectedMonth)) ? Number(p.selectedMonth) : selectedMonth,
          buckets: Array.isArray(p?.buckets) ? p.buckets : [],
          recurringIncome: Array.isArray(p?.recurringIncome) ? p.recurringIncome : (Array.isArray(p?.income) ? p.income : []),
          recurringBills: Array.isArray(p?.recurringBills) ? p.recurringBills : (Array.isArray(p?.bills) ? p.bills : []),
          transactions: Array.isArray(p?.transactions) ? p.transactions : [],
        };

        out.buckets = out.buckets.map(b => ({
          id: b.id ?? Date.now() + Math.random(),
          name: String(b.name ?? "Bucket"),
          budgeted: round2(Number(b.budgeted ?? 0)),
          spent: round2(Number(b.spent ?? 0)),
          period: (b.period === "weekly") ? "weekly" : "monthly",
        }));

        out.recurringIncome = out.recurringIncome.map(i => ({
          id: i.id ?? Date.now() + Math.random(),
          name: String(i.name ?? "Income"),
          amount: round2(Number(i.amount ?? 0)),
          frequency: ["monthly","weekly","biweekly","once"].includes(i.frequency) ? i.frequency : "monthly",
          nextDate: i.nextDate || "",
        }));

        out.recurringBills = out.recurringBills.map(b => {
          const freq = ["monthly","weekly","yearly"].includes(b.frequency) ? b.frequency : "monthly";
          const base = {
            id: b.id ?? Date.now() + Math.random(),
            name: String(b.name ?? "Bill"),
            amount: round2(Number(b.amount ?? 0)),
            frequency: freq,
          };
          if (freq === "monthly") return { ...base, dueDay: clamp(Number(b.dueDay ?? 1), 1, 28) };
          if (freq === "yearly") return { ...base, dueMonth: clamp(Number(b.dueMonth ?? 1), 1, 12), dueDay: clamp(Number(b.dueDay ?? 1), 1, 28) };
          return { ...base, nextDate: b.nextDate || "" };
        });

        out.transactions = out.transactions.map(t => ({
          id: t.id ?? (Date.now() + Math.random()),
          bucketId: Number(t.bucketId ?? 0),
          amount: round2(Number(t.amount ?? 0)),
          description: String(t.description ?? ""),
          date: t.date || "",
        }));

        return out;
      };

      const extractJsonFromText = (text) => {
        const startIdx = text.indexOf(JSON_START);
        const endIdx = text.indexOf(JSON_END);

        if (startIdx !== -1 && endIdx !== -1 && endIdx > startIdx) {
          const jsonStr = text.slice(startIdx + JSON_START.length, endIdx).trim();
          return JSON.parse(jsonStr);
        }

        const trimmed = text.trim();

        try { return JSON.parse(trimmed); } catch (e) {}

        const first = trimmed.indexOf("{");
        const last = trimmed.lastIndexOf("}");
        if (first !== -1 && last !== -1 && last > first) {
          const maybe = trimmed.slice(first, last + 1);
          return JSON.parse(maybe);
        }

        throw new Error("No JSON found");
      };

      const parseLegacyMonthlySummary = (text) => {
        const lines = String(text || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean);

        const out = {
          version: 0,
          exportedAt: new Date().toISOString(),
          buckets: [],
          recurringIncome: [],
          recurringBills: [],
          transactions: [],
        };

        let mode = "";
        for (const line of lines) {
          const upper = line.toUpperCase();
          if (upper.startsWith("INCOME:")) { mode = "income"; continue; }
          if (upper.startsWith("BUCKETS:")) { mode = "buckets"; continue; }
          if (upper.startsWith("BILLS:")) { mode = "bills"; continue; }
          if (upper.startsWith("TOTAL_") || upper.startsWith("MONTHLY SUMMARY")) continue;

          if (mode === "income") {
            const parts = line.split(",").map(x => x.trim());
            if (parts.length >= 4) {
              out.recurringIncome.push({
                id: Date.now() + Math.random(),
                name: parts[0],
                amount: round2(Number(parts[1] || 0)),
                frequency: (["weekly","biweekly","monthly","once"].includes(parts[2]?.toLowerCase())) ? parts[2].toLowerCase() : "monthly",
                nextDate: parts[3] || "",
              });
            }
            continue;
          }

          if (mode === "buckets") {
            const parts = line.split(",").map(x => x.trim());
            if (parts.length >= 2) {
              out.buckets.push({
                id: Date.now() + Math.random(),
                name: parts[0],
                budgeted: round2(Number(parts[1] || 0)),
                spent: round2(Number(parts[2] || 0)),
                period: "monthly",
              });
            }
            continue;
          }

          if (mode === "bills") {
            const parts = line.split(",").map(x => x.trim());
            if (parts.length >= 3) {
              const d = parseYMDLocal(parts[2]);
              out.recurringBills.push({
                id: Date.now() + Math.random(),
                name: parts[0],
                amount: round2(Number(parts[1] || 0)),
                frequency: "monthly",
                dueDay: d ? clamp(d.getDate(), 1, 28) : 1,
              });
            }
            continue;
          }
        }

        if (!out.buckets.length && !out.recurringIncome.length && !out.recurringBills.length) {
          throw new Error("Legacy format not recognized");
        }
        return out;
      };

      const handleUpload = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const text = String(ev.target.result || "");
            let raw;

            try {
              raw = extractJsonFromText(text);
            } catch (jsonErr) {
              raw = parseLegacyMonthlySummary(text);
            }

            const payload = normalizePayload(raw);

            setSelectedYear(payload.selectedYear ?? selectedYear);
            setSelectedMonth(payload.selectedMonth ?? selectedMonth);

            setBuckets(payload.buckets);
            setRecurringIncome(payload.recurringIncome);
            setRecurringBills(payload.recurringBills);

            setTransactions((prev) => {
              const seen = new Set(prev.map(txKey));
              const toAdd = payload.transactions.filter(t => {
                const k = txKey(t);
                if (seen.has(k)) return false;
                seen.add(k);
                return true;
              });
              return [...prev, ...toAdd];
            });

            alert("Imported ‚úÖ");
          } catch (err) {
            alert("Could not import that file. If it‚Äôs an old summary, make sure it includes INCOME:, BUCKETS:, and/or BILLS sections, OR download a fresh backup from this version.");
          } finally {
            e.target.value = "";
          }
        };
        reader.readAsText(file);
      };

      // ---------------- Month transactions helper ----------------
      const monthTransactions = transactions
        .filter(t => {
          const d = parseYMDLocal(t.date);
          return d && d >= monthStart && d <= monthEnd;
        })
        .slice()
        .sort((a, b) => (a.date < b.date ? 1 : -1));

      const monthTxTotal = round2(monthTransactions.reduce((s, t) => s + (Number(t.amount) || 0), 0));
      const monthTxCount = monthTransactions.length;

      // ---------------- Editing states (IDs only) ----------------
      const [editingBucketId, setEditingBucketId] = React.useState(null);
      const [editingIncomeId, setEditingIncomeId] = React.useState(null);
      const [editingBillId, setEditingBillId] = React.useState(null);

      // ---- Edit start/cancel/save (refs) ----
      const startEditBucket = (b) => {
        setEditingBucketId(b.id);
        bucketDraftRef.current = { ...b, budgeted: String(b.budgeted ?? "") };
        setEditKey(k => k + 1);
      };
      const cancelEditBucket = () => { setEditingBucketId(null); bucketDraftRef.current = null; setEditKey(k => k + 1); };
      const saveEditBucket = () => {
        const d = bucketDraftRef.current;
        if (!d) return;
        updateBucket(d.id, {
          name: String(d.name || "").trim() || "Bucket",
          budgeted: parseMoney(d.budgeted),
          period: d.period === "weekly" ? "weekly" : "monthly"
        });
        cancelEditBucket();
      };

      const startEditIncome = (i) => {
        setEditingIncomeId(i.id);
        incomeDraftRef.current = { ...i, amount: String(i.amount ?? "") };
        setEditKey(k => k + 1);
      };
      const cancelEditIncome = () => { setEditingIncomeId(null); incomeDraftRef.current = null; setEditKey(k => k + 1); };
      const saveEditIncome = () => {
        const d = incomeDraftRef.current;
        if (!d) return;
        updateIncome(d.id, {
          name: String(d.name || "").trim() || "Income",
          amount: parseMoney(d.amount),
          frequency: d.frequency,
          nextDate: d.nextDate || ""
        });
        cancelEditIncome();
      };

      const startEditBill = (b) => {
        setEditingBillId(b.id);
        billDraftRef.current = {
          ...b,
          amount: String(b.amount ?? ""),
          dueDay: b.dueDay != null ? String(b.dueDay) : "",
          dueMonth: b.dueMonth != null ? String(b.dueMonth) : "",
          nextDate: b.nextDate || ""
        };
        setEditKey(k => k + 1);
      };
      const cancelEditBill = () => { setEditingBillId(null); billDraftRef.current = null; setEditKey(k => k + 1); };
      const saveEditBill = () => {
        const d = billDraftRef.current;
        if (!d) return;
        const freq = d.frequency;
        const patch = {
          name: String(d.name || "").trim() || "Bill",
          amount: parseMoney(d.amount),
          frequency: freq,
        };
        if (freq === "monthly") patch.dueDay = clamp(parseInt(d.dueDay || "1", 10), 1, 28);
        if (freq === "yearly") {
          patch.dueMonth = clamp(parseInt(d.dueMonth || "1", 10), 1, 12);
          patch.dueDay = clamp(parseInt(d.dueDay || "1", 10), 1, 28);
        }
        if (freq === "weekly") patch.nextDate = d.nextDate || "";
        updateBill(d.id, patch);
        cancelEditBill();
      };

      // ---------------- Weekly Summary (next 4 weeks) ----------------
      const getWeekRange = (startDate) => {
        const s = new Date(startDate); s.setHours(0,0,0,0);
        const e = addDays(s, 6); e.setHours(23,59,59,999);
        return { start: s, end: e };
      };

      const yearlyBillsWeeklyReserve = round2(
        recurringBills
          .filter(b => b.frequency === "yearly")
          .reduce((s, b) => s + (Number(b.amount) || 0), 0) / 52
      );

      const monthlyBucketTotalOnly = round2(
        buckets.filter(b => b.period !== "weekly").reduce((s,b) => s + (Number(b.budgeted) || 0), 0)
      );

      const weeklyBucketTotalOnly = round2(
        buckets.filter(b => b.period === "weekly").reduce((s,b) => s + (Number(b.budgeted) || 0), 0)
      );

      // ‚úÖ Expenses are "living", so show them steady weekly (based on selected month)
      const monthWeeksCount = Math.max(1, countCustomWeeksInMonth());
      const monthlyBucketsWeeklySplit = round2(monthlyBucketTotalOnly / monthWeeksCount);
      const weeklyExpensesPlanned = round2(weeklyBucketTotalOnly + monthlyBucketsWeeklySplit);
      const monthlyExpensesPlanned = round2(totalMonthlyBudgeted);

      // ‚úÖ Smart bills funding plan:
      // - If there are mixed pay frequencies (not all weekly), allocate bills across EACH income's paydays
      //   using that income's share of monthly repeating income.
      // - If everyone is weekly, keep the old (simple) per-paycheck behavior.
      const buildBillsFundingPlan = () => {
        const incomes = recurringIncome
          .filter(i => i.frequency !== "once")
          .filter(i => {
            if ((i.frequency === "weekly" || i.frequency === "biweekly") && !parseYMDLocal(i.nextDate)) return false;
            return true;
          });

        if (!incomes.length) {
          return { enabled: false, incomes: [], perPaycheckBills: {} };
        }

        const allWeekly = incomes.every(i => i.frequency === "weekly");
        const enabled = !allWeekly;

        const meta = incomes.map(i => {
          const occ = Math.max(1, countOccurrencesInSelectedMonth(i) || 1);
          const monthlyVal = monthlyFromIncome(i); // month-accurate
          return { id: i.id, occ, monthlyVal };
        });

        const totalMonthly = meta.reduce((s, x) => s + (Number(x.monthlyVal) || 0), 0);
        const perPaycheckBills = {};

        if (totalMonthly > 0) {
          meta.forEach(m => {
            const share = (Number(m.monthlyVal) || 0) / totalMonthly;
            perPaycheckBills[m.id] = round2((share * totalBillsDueThisMonth) / m.occ);
          });
        } else {
          const eq = 1 / meta.length;
          meta.forEach(m => {
            perPaycheckBills[m.id] = round2((eq * totalBillsDueThisMonth) / m.occ);
          });
        }

        return { enabled, incomes, perPaycheckBills };
      };

      const billsFundingPlan = buildBillsFundingPlan();

      const listFundingPaychecksInRange = (rangeStart, rangeEnd) => {
        if (billsFundingPlan.enabled) {
          const out = [];
          billsFundingPlan.incomes.forEach(i => out.push(...listOccurrencesInRange(i, "income", rangeStart, rangeEnd)));
          return out;
        }
        const main = getMainPaycheck();
        if (!main) return [];
        return listOccurrencesInRange(main, "income", rangeStart, rangeEnd);
      };

      const spendingTotalInRange = (rangeStart, rangeEnd) => {
        const s = new Date(rangeStart); s.setHours(0,0,0,0);
        const e = new Date(rangeEnd); e.setHours(23,59,59,999);
        return round2(
          transactions.filter(t => {
            const d = parseYMDLocal(t.date);
            return d && d >= s && d <= e;
          }).reduce((sum,t) => sum + (Number(t.amount) || 0), 0)
        );
      };

      const nextFourWeeks = Array.from({ length: 4 }, (_, idx) => {
        const start = addDays(thisWeekStart, idx * 7);
        const { start: s, end: e } = getWeekRange(start);
        const events = weekEvents(s, e);
        const totals = totalsForEvents(events);

        const fundingPaychecks = listFundingPaychecksInRange(s, e);
        const paycheckCount = fundingPaychecks.length;

        const billsDueThisWeek = round2(events.filter(x => x.type === "bill").reduce((sum,x)=>sum + x.amount, 0));

        const billsSinkingFundThisWeek = billsFundingPlan.enabled
          ? round2(fundingPaychecks.reduce((sum, p) => sum + (Number(billsFundingPlan.perPaycheckBills?.[p.sourceId]) || 0), 0))
          : (paycheckCount > 0 ? round2(perPaycheckSetAsideForBills * paycheckCount) : 0);

        // steady expenses weekly (living)
        const monthlyExpensesSinkingFundThisWeek = monthlyBucketsWeeklySplit;

        const plannedExpensesThisWeek = round2(weeklyBucketTotalOnly + monthlyExpensesSinkingFundThisWeek);

        // bills "weekly version" (based on paychecks) + annual reserve
        const plannedBillsSaveThisWeek = round2(billsSinkingFundThisWeek + yearlyBillsWeeklyReserve);

        const netAfterPlan = round2(totals.income - plannedBillsSaveThisWeek - plannedExpensesThisWeek);

        const actualSpent = spendingTotalInRange(s, e);

        return {
          idx,
          start: s,
          end: e,
          events,
          totals,
          paycheckCount,

          // actual bills due in that week (from schedule)
          billsDueThisWeek,

          // bills saving plan based on paychecks
          billsSinkingFundThisWeek,
          annualReserve: yearlyBillsWeeklyReserve,
          plannedBillsSaveThisWeek,

          // expenses plan weekly version
          monthlyExpenseSplitThisWeek: monthlyExpensesSinkingFundThisWeek,
          plannedExpensesThisWeek,

          // final plan net
          netAfterPlan,

          // actual spend from transactions
          actualSpent,

          usingSmartBillsFunding: billsFundingPlan.enabled
        };
      });

      // ---------------- Summary math user asked for ----------------
      const monthlyNetAfterPlan = round2(totalMonthlyIncome - totalBillsDueThisMonth - monthlyExpensesPlanned);

      const thisWeekNetAfterActualBillsAndPlannedExpenses = round2(
        thisWeekTotals.income - thisWeekTotals.bills - weeklyExpensesPlanned
      );
      const nextWeekNetAfterActualBillsAndPlannedExpenses = round2(
        nextWeekTotals.income - nextWeekTotals.bills - weeklyExpensesPlanned
      );

      // Bills funding helper: describe pattern + show amounts
      const getFundingPattern = () => {
        const incomes = recurringIncome
          .filter(i => i.frequency !== "once")
          .filter(i => {
            if ((i.frequency === "weekly" || i.frequency === "biweekly") && !parseYMDLocal(i.nextDate)) return false;
            return true;
          });

        const freqs = Array.from(new Set(incomes.map(i => i.frequency)));
        const allWeekly = incomes.length > 0 && incomes.every(i => i.frequency === "weekly");
        const allBiweekly = incomes.length > 0 && incomes.every(i => i.frequency === "biweekly");
        const allMonthly = incomes.length > 0 && incomes.every(i => i.frequency === "monthly");
        const mixed = incomes.length > 0 && !allWeekly && !allBiweekly && !allMonthly;

        return { incomes, freqs, allWeekly, allBiweekly, allMonthly, mixed };
      };

      const fundingPattern = getFundingPattern();
      const thisWeekFundingPaychecks = listFundingPaychecksInRange(thisWeekStart, thisWeekEnd);
      const nextWeekFundingPaychecks = listFundingPaychecksInRange(nextWeekStart, nextWeekEnd);

      const thisWeekBillsSave = billsFundingPlan.enabled
        ? round2(thisWeekFundingPaychecks.reduce((s,p)=> s + (Number(billsFundingPlan.perPaycheckBills?.[p.sourceId])||0), 0))
        : round2(perPaycheckSetAsideForBills * thisWeekFundingPaychecks.length);

      const nextWeekBillsSave = billsFundingPlan.enabled
        ? round2(nextWeekFundingPaychecks.reduce((s,p)=> s + (Number(billsFundingPlan.perPaycheckBills?.[p.sourceId])||0), 0))
        : round2(perPaycheckSetAsideForBills * nextWeekFundingPaychecks.length);

      const annualReserveThisWeek = yearlyBillsWeeklyReserve;
      const annualReserveNextWeek = yearlyBillsWeeklyReserve;

      // ---------------- Render ----------------
      return (
        <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-sky-50 to-emerald-50">
          <div className="max-w-6xl mx-auto p-2 sm:p-4 md:p-6">

            {/* Header */}
            <header className="mb-4 sm:mb-6">
              <div className="bg-white/80 backdrop-blur rounded-2xl border border-slate-100 shadow-sm">
                <div className="p-3 sm:p-4">
                  <div className="flex flex-col gap-3">
                    <div className="flex items-start justify-between gap-3">
                      <div className="min-w-0">
                        <h1 className="text-2xl sm:text-3xl font-extrabold text-slate-800">üí∞ Budget Buckets</h1>
                        <div className="mt-2 flex flex-wrap gap-2">
                          <Pill className="bg-slate-50 text-slate-700 border-slate-200">
                            {new Date(selectedYear, selectedMonth).toLocaleDateString("en-US", { month: "long", year: "numeric" })}
                          </Pill>
                          <Pill className="bg-sky-50 text-sky-700 border-sky-200">
                            Week starts: <span className="ml-1 font-semibold">{weekStartLabel}</span>
                          </Pill>
                          <Pill className="bg-emerald-50 text-emerald-700 border-emerald-200">
                            Paychecks this month: <span className="ml-1 font-semibold">{paydaysThisMonth}</span>
                          </Pill>
                          {usedFallbackPaydays && (
                            <Pill className="bg-amber-50 text-amber-800 border-amber-200">‚ö†Ô∏è estimate</Pill>
                          )}
                        </div>
                      </div>

                      <div className="flex items-center gap-2">
                        <select
                          value={selectedMonth}
                          onChange={(e) => setSelectedMonth(parseInt(e.target.value, 10))}
                          className={inputBase + " min-w-[120px]"}
                        >
                          {Array.from({ length: 12 }, (_, i) =>
                            <option key={i} value={i}>
                              {new Date(2000, i).toLocaleString("en-US", { month: "long" })}
                            </option>
                          )}
                        </select>

                        <input
                          type="number"
                          value={selectedYear}
                          onChange={(e) => setSelectedYear(parseInt(e.target.value, 10))}
                          className={inputBase + " w-24"}
                        />

                        <details className="relative">
                          <summary className={buttonBase + " " + btnSoft + " cursor-pointer select-none"}>Tools ‚ñæ</summary>
                          <div className="absolute right-0 mt-2 w-72 bg-white border border-slate-200 rounded-xl shadow-lg p-2 z-10">
                            <button onClick={downloadDataBackup} className={buttonBase + " " + btnPrimary + " w-full"}>
                              Download Backup
                            </button>
                            <label className={buttonBase + " " + btnSoft + " w-full mt-2 text-center cursor-pointer block"}>
                              Upload Backup
                              <input type="file" accept=".txt,.json" onChange={handleUpload} className="hidden" />
                            </label>
                            <div className="mt-2 text-xs text-slate-500">
                              Imports markers JSON, raw JSON, and older Monthly Summary text (best-effort). Transactions merge (no duplicates).
                            </div>
                          </div>
                        </details>
                      </div>
                    </div>

                    {hasAnyAnchorWarnings && (
                      <div className="p-3 rounded-xl border border-amber-200 bg-amber-50 text-amber-900">
                        <div className="font-semibold text-sm">‚ö†Ô∏è Setup warnings (fix for accurate scheduling)</div>
                        <ul className="mt-1 text-sm list-disc ml-5">
                          {missingIncomeAnchors.length > 0 && (
                            <li>Weekly/biweekly income missing anchor date: <span className="font-semibold">{missingIncomeAnchors.map(x => x.name).join(", ")}</span></li>
                          )}
                          {missingBillAnchors.length > 0 && (
                            <li>Weekly bills missing anchor date: <span className="font-semibold">{missingBillAnchors.map(x => x.name).join(", ")}</span></li>
                          )}
                          {missingOnceDates.length > 0 && (
                            <li>One-time income missing date: <span className="font-semibold">{missingOnceDates.map(x => x.name).join(", ")}</span></li>
                          )}
                        </ul>
                      </div>
                    )}
                  </div>
                </div>

                <div className="border-t border-slate-100 px-3 sm:px-4 py-2">
                  <nav className="flex flex-wrap gap-2">
                    {["summary", "weekly", "buckets", "income", "bills", "transactions"].map(tab =>
                      <button
                        key={tab}
                        onClick={() => setActiveTab(tab)}
                        className={`px-3 py-1 rounded-full text-sm shadow ${
                          activeTab === tab ? "bg-indigo-600 text-white" : "bg-white text-slate-700 hover:bg-slate-50 border border-slate-200"
                        }`}
                      >
                        {tab === "weekly" ? "Weekly Summary" : tab.charAt(0).toUpperCase() + tab.slice(1)}
                      </button>
                    )}
                  </nav>
                </div>
              </div>
            </header>

            {/* -------------------- SUMMARY -------------------- */}
            {activeTab === "summary" && (
              <section className="space-y-4">
                {/* Month-level summary (requested) */}
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                  <StatCard label="Income (this month)" value={currency(totalMonthlyIncome)} sub="Counts paydays inside selected month" tone="emerald" />
                  <StatCard label="Bills due (this month)" value={`-${currency(totalBillsDueThisMonth).slice(1)}`} sub="Actual scheduled bills inside selected month" tone="rose" />
                  <StatCard label="Expenses plan (this month)" value={`-${currency(monthlyExpensesPlanned).slice(1)}`} sub="Based on your bucket budgets" tone="rose" />
                  <StatCard label="Net after bills + expenses" value={currency(monthlyNetAfterPlan)} sub="Income ‚àí Bills Due ‚àí Expenses Plan" tone={monthlyNetAfterPlan >= 0 ? "emerald" : "rose"} />
                </div>

                {/* Week-of + Next week sections (requested) */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <Card className="p-4">
                    <div className="flex items-start justify-between">
                      <div>
                        <h2 className="text-lg font-extrabold text-slate-800">This week</h2>
                        <div className="text-xs text-slate-500 mt-1">{fmtDate(thisWeekStart)} ‚Üí {fmtDate(thisWeekEnd)}</div>
                      </div>
                      <Pill className="bg-slate-50 text-slate-700 border-slate-200">
                        Net after: <span className="ml-1 font-semibold">{currency(thisWeekNetAfterActualBillsAndPlannedExpenses)}</span>
                      </Pill>
                    </div>

                    <div className="mt-3 grid grid-cols-4 gap-2">
                      <div className="p-3 rounded-xl border border-emerald-100 bg-emerald-50">
                        <div className="text-xs text-emerald-700 font-semibold">Income</div>
                        <div className="text-lg font-extrabold text-emerald-800">{currency(thisWeekTotals.income)}</div>
                      </div>
                      <div className="p-3 rounded-xl border border-rose-100 bg-rose-50">
                        <div className="text-xs text-rose-700 font-semibold">Bills due</div>
                        <div className="text-lg font-extrabold text-rose-800">-{currency(thisWeekTotals.bills).slice(1)}</div>
                      </div>
                      <div className="p-3 rounded-xl border border-slate-100 bg-slate-50">
                        <div className="text-xs text-slate-600 font-semibold">Expenses (weekly)</div>
                        <div className="text-lg font-extrabold text-slate-800">-{currency(weeklyExpensesPlanned).slice(1)}</div>
                      </div>
                      <div className="p-3 rounded-xl border border-indigo-100 bg-indigo-50">
                        <div className="text-xs text-indigo-700 font-semibold">Net</div>
                        <div className="text-lg font-extrabold text-indigo-800">{currency(thisWeekNetAfterActualBillsAndPlannedExpenses)}</div>
                      </div>
                    </div>

                    <div className="mt-3 space-y-2">
                      {thisWeekEvents.length === 0 ? (
                        <div className="text-sm text-slate-500">No scheduled income/bills this week.</div>
                      ) : thisWeekEvents.map(ev => (
                        <div key={ev.id} className="flex items-center justify-between text-sm">
                          <div className="text-slate-700">
                            <span className="font-semibold">{niceDate(ev.date)}</span>
                            <span className="text-slate-400"> ¬∑ </span>
                            {ev.name}
                            <span className="text-slate-400"> ¬∑ </span>
                            <span className="text-xs text-slate-500">{ev.type}</span>
                          </div>
                          <div className={`font-extrabold ${ev.type === "income" ? "text-emerald-700" : "text-rose-700"}`}>
                            {ev.type === "income" ? currency(ev.amount) : `-${currency(ev.amount).slice(1)}`}
                          </div>
                        </div>
                      ))}
                    </div>
                  </Card>

                  <Card className="p-4">
                    <div className="flex items-start justify-between">
                      <div>
                        <h2 className="text-lg font-extrabold text-slate-800">Next week</h2>
                        <div className="text-xs text-slate-500 mt-1">{fmtDate(nextWeekStart)} ‚Üí {fmtDate(nextWeekEnd)}</div>
                      </div>
                      <Pill className="bg-slate-50 text-slate-700 border-slate-200">
                        Net after: <span className="ml-1 font-semibold">{currency(nextWeekNetAfterActualBillsAndPlannedExpenses)}</span>
                      </Pill>
                    </div>

                    <div className="mt-3 grid grid-cols-4 gap-2">
                      <div className="p-3 rounded-xl border border-emerald-100 bg-emerald-50">
                        <div className="text-xs text-emerald-700 font-semibold">Income</div>
                        <div className="text-lg font-extrabold text-emerald-800">{currency(nextWeekTotals.income)}</div>
                      </div>
                      <div className="p-3 rounded-xl border border-rose-100 bg-rose-50">
                        <div className="text-xs text-rose-700 font-semibold">Bills due</div>
                        <div className="text-lg font-extrabold text-rose-800">-{currency(nextWeekTotals.bills).slice(1)}</div>
                      </div>
                      <div className="p-3 rounded-xl border border-slate-100 bg-slate-50">
                        <div className="text-xs text-slate-600 font-semibold">Expenses (weekly)</div>
                        <div className="text-lg font-extrabold text-slate-800">-{currency(weeklyExpensesPlanned).slice(1)}</div>
                      </div>
                      <div className="p-3 rounded-xl border border-indigo-100 bg-indigo-50">
                        <div className="text-xs text-indigo-700 font-semibold">Net</div>
                        <div className="text-lg font-extrabold text-indigo-800">{currency(nextWeekNetAfterActualBillsAndPlannedExpenses)}</div>
                      </div>
                    </div>

                    <div className="mt-3 space-y-2">
                      {nextWeekEvents.length === 0 ? (
                        <div className="text-sm text-slate-500">No scheduled income/bills next week.</div>
                      ) : nextWeekEvents.map(ev => (
                        <div key={ev.id} className="flex items-center justify-between text-sm">
                          <div className="text-slate-700">
                            <span className="font-semibold">{niceDate(ev.date)}</span>
                            <span className="text-slate-400"> ¬∑ </span>
                            {ev.name}
                            <span className="text-slate-400"> ¬∑ </span>
                            <span className="text-xs text-slate-500">{ev.type}</span>
                          </div>
                          <div className={`font-extrabold ${ev.type === "income" ? "text-emerald-700" : "text-rose-700"}`}>
                            {ev.type === "income" ? currency(ev.amount) : `-${currency(ev.amount).slice(1)}`}
                          </div>
                        </div>
                      ))}
                    </div>
                  </Card>
                </div>

                {/* Bills funding (requested "best way to save based on paychecks") + transactions quick stats */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                  <Card className="lg:col-span-2 p-4">
                    <div className="flex items-start justify-between gap-2">
                      <div>
                        <h2 className="text-lg font-extrabold text-slate-800">Bills funding</h2>
                        <div className="text-xs text-slate-500 mt-1">
                          Bills due this month (actual): <span className="font-semibold text-slate-700">{currency(totalBillsDueThisMonth)}</span>
                          <span className="text-slate-400"> ¬∑ </span>
                          Annual reserve: <span className="font-semibold text-slate-700">{currency(yearlyBillsWeeklyReserve)}</span><span className="text-slate-500">/week</span>
                        </div>
                      </div>
                      {usedFallbackPaydays && (
                        <Pill className="bg-amber-50 text-amber-800 border-amber-200">‚ö†Ô∏è estimate</Pill>
                      )}
                    </div>

                    {/* Strategy box */}
                    <div className="mt-4 p-4 rounded-2xl border border-indigo-100 bg-indigo-50">
                      <div className="text-xs uppercase tracking-wide text-indigo-700 font-semibold">Best way to save (based on paychecks)</div>

                      {/* Case A: all weekly */}
                      {fundingPattern.allWeekly && (
                        <>
                          <div className="mt-2 text-sm text-indigo-900">
                            Everyone is paid <span className="font-semibold">weekly</span> ‚Üí save a steady amount each week.
                          </div>
                          <div className="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <div className="p-3 rounded-xl bg-white border border-indigo-100">
                              <div className="text-xs text-slate-500">Bills (per week)</div>
                              <div className="text-xl font-extrabold text-indigo-800">{currency(perPaycheckSetAsideForBills)}</div>
                            </div>
                            <div className="p-3 rounded-xl bg-white border border-indigo-100">
                              <div className="text-xs text-slate-500">Annual reserve (per week)</div>
                              <div className="text-xl font-extrabold text-indigo-800">{currency(yearlyBillsWeeklyReserve)}</div>
                            </div>
                            <div className="p-3 rounded-xl bg-white border border-indigo-100">
                              <div className="text-xs text-slate-500">Total to save (per week)</div>
                              <div className="text-xl font-extrabold text-indigo-800">{currency(round2(perPaycheckSetAsideForBills + yearlyBillsWeeklyReserve))}</div>
                            </div>
                          </div>
                        </>
                      )}

                      {/* Case B: all biweekly */}
                      {fundingPattern.allBiweekly && (
                        <>
                          <div className="mt-2 text-sm text-indigo-900">
                            Everyone is paid <span className="font-semibold">bi-weekly</span> ‚Üí save per paycheck.
                          </div>
                          <div className="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <div className="p-3 rounded-xl bg-white border border-indigo-100">
                              <div className="text-xs text-slate-500">Bills (per paycheck)</div>
                              <div className="text-xl font-extrabold text-indigo-800">{currency(perPaycheckSetAsideForBills)}</div>
                            </div>
                            <div className="p-3 rounded-xl bg-white border border-indigo-100">
                              <div className="text-xs text-slate-500">Annual reserve (per paycheck)</div>
                              <div className="text-xl font-extrabold text-indigo-800">{currency(round2(yearlyBillsWeeklyReserve * 2))}</div>
                            </div>
                            <div className="p-3 rounded-xl bg-white border border-indigo-100">
                              <div className="text-xs text-slate-500">Total to save (per paycheck)</div>
                              <div className="text-xl font-extrabold text-indigo-800">{currency(round2(perPaycheckSetAsideForBills + (yearlyBillsWeeklyReserve * 2)))}</div>
                            </div>
                          </div>
                        </>
                      )}

                      {/* Mixed / smart plan */}
                      {(fundingPattern.mixed || (!fundingPattern.allWeekly && !fundingPattern.allBiweekly)) && (
                        <>
                          <div className="mt-2 text-sm text-indigo-900">
                            Mixed pay schedules ‚Üí save based on the paychecks that actually hit each week.
                          </div>

                          <div className="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-3">
                            <div className="p-3 rounded-xl bg-white border border-indigo-100">
                              <div className="text-xs text-slate-500 font-semibold">Per paycheck (by income)</div>
                              <div className="mt-2 space-y-1 text-sm text-slate-700">
                                {billsFundingPlan.enabled ? (
                                  billsFundingPlan.incomes.map(i => (
                                    <div key={i.id} className="flex justify-between">
                                      <span className="truncate">{i.name} <span className="text-slate-400">¬∑ {i.frequency}</span></span>
                                      <span className="font-extrabold text-indigo-800">{currency(billsFundingPlan.perPaycheckBills?.[i.id] || 0)}</span>
                                    </div>
                                  ))
                                ) : (
                                  <div className="text-sm text-slate-600">Add anchor dates to weekly/biweekly income to enable smart funding.</div>
                                )}
                              </div>
                              <div className="mt-2 text-xs text-slate-500">
                                Annual reserve stays: <span className="font-semibold">{currency(yearlyBillsWeeklyReserve)}</span>/week.
                              </div>
                            </div>

                            <div className="p-3 rounded-xl bg-white border border-indigo-100">
                              <div className="text-xs text-slate-500 font-semibold">What to save this week vs next week</div>
                              <div className="mt-2 space-y-2 text-sm text-slate-700">
                                <div className="p-2 rounded-lg bg-slate-50 border border-slate-100">
                                  <div className="flex justify-between">
                                    <span>This week bills-save (from paychecks)</span>
                                    <span className="font-extrabold text-indigo-800">{currency(thisWeekBillsSave)}</span>
                                  </div>
                                  <div className="flex justify-between">
                                    <span>+ annual reserve</span>
                                    <span className="font-extrabold text-indigo-800">{currency(annualReserveThisWeek)}</span>
                                  </div>
                                  <div className="flex justify-between">
                                    <span className="font-semibold">Total to save</span>
                                    <span className="font-extrabold text-indigo-900">{currency(round2(thisWeekBillsSave + annualReserveThisWeek))}</span>
                                  </div>
                                </div>

                                <div className="p-2 rounded-lg bg-slate-50 border border-slate-100">
                                  <div className="flex justify-between">
                                    <span>Next week bills-save (from paychecks)</span>
                                    <span className="font-extrabold text-indigo-800">{currency(nextWeekBillsSave)}</span>
                                  </div>
                                  <div className="flex justify-between">
                                    <span>+ annual reserve</span>
                                    <span className="font-extrabold text-indigo-800">{currency(annualReserveNextWeek)}</span>
                                  </div>
                                  <div className="flex justify-between">
                                    <span className="font-semibold">Total to save</span>
                                    <span className="font-extrabold text-indigo-900">{currency(round2(nextWeekBillsSave + annualReserveNextWeek))}</span>
                                  </div>
                                </div>

                                <div className="text-xs text-slate-500">
                                  This uses the paychecks that land inside each week, so weeks with two paychecks naturally ‚Äúsave more.‚Äù
                                </div>
                              </div>
                            </div>
                          </div>
                        </>
                      )}
                    </div>

                    <div className="mt-4">
                      <div className="text-xs uppercase tracking-wide text-slate-500 font-semibold">Bills due this month</div>
                      <div className="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        {monthBills.length === 0 ? (
                          <div className="text-sm text-slate-500">No bills scheduled in this month.</div>
                        ) : monthBills.slice(0, 12).map(e => (
                          <div key={e.id} className="flex items-center justify-between text-sm p-2 rounded-lg border border-slate-100 bg-slate-50">
                            <div className="text-slate-700">
                              <span className="font-semibold">{niceDate(e.date)}</span>
                              <span className="text-slate-400"> ¬∑ </span>
                              {e.name}
                            </div>
                            <div className="font-extrabold text-rose-700">-{currency(e.amount).slice(1)}</div>
                          </div>
                        ))}
                      </div>
                      {monthBills.length > 12 && (
                        <div className="mt-2 text-xs text-slate-500">‚Ä¶and {monthBills.length - 12} more bills this month</div>
                      )}
                    </div>
                  </Card>

                  <Card className="p-4">
                    <div className="text-xs text-slate-500">This month transactions</div>
                    <div className="mt-2 flex items-end justify-between">
                      <div>
                        <div className="text-3xl font-extrabold text-slate-800">{monthTxCount}</div>
                        <div className="text-xs text-slate-500 mt-1">Count in selected month</div>
                      </div>
                      <div className="text-right">
                        <div className="text-xs text-slate-500">Actual spending total</div>
                        <div className="text-xl font-extrabold text-slate-800">{currency(monthTxTotal)}</div>
                      </div>
                    </div>
                    <div className="mt-4 p-3 rounded-xl border border-slate-100 bg-slate-50">
                      <div className="text-xs text-slate-500">Actual spent so far</div>
                      <div className="mt-1 text-lg font-extrabold text-slate-800">{currency(totalMonthlySpent)}</div>
                      <div className="text-xs text-slate-500 mt-1">This is from transactions (not budgets).</div>
                    </div>
                  </Card>
                </div>
              </section>
            )}

            {/* -------------------- WEEKLY SUMMARY (Next 4 weeks) -------------------- */}
            {activeTab === "weekly" && (
              <section className="space-y-4">
                <Card className="p-4">
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <h2 className="text-xl font-extrabold text-slate-800">Weekly Summary (Next 4 weeks)</h2>
                      <div className="text-xs text-slate-500 mt-1">
                        Each week shows: total income, <span className="font-semibold">bills saving plan (based on paychecks)</span>, weekly expenses plan, and the net after both. Below that: actual bills due + total.
                      </div>
                    </div>
                    {usedFallbackPaydays && (
                      <Pill className="bg-amber-50 text-amber-800 border-amber-200">‚ö†Ô∏è paycheck count estimate</Pill>
                    )}
                  </div>
                </Card>

                {nextFourWeeks.map(w => (
                  <Card key={w.idx} className="p-4">
                    <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                      <div>
                        <div className="text-sm text-slate-500">Week {w.idx + 1}</div>
                        <div className="text-lg font-extrabold text-slate-800">
                          {fmtDate(w.start)} ‚Üí {fmtDate(w.end)}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                          Paychecks this week: <span className="font-semibold text-slate-700">{w.paycheckCount}</span>
                          {w.usingSmartBillsFunding && <span className="ml-2 text-emerald-700 font-semibold">¬∑ smart</span>}
                        </div>
                      </div>

                      <div className="flex flex-wrap gap-2">
                        <Pill className="bg-emerald-50 text-emerald-700 border-emerald-200">
                          Income: <span className="ml-1 font-semibold">{currency(w.totals.income)}</span>
                        </Pill>
                        <Pill className="bg-indigo-50 text-indigo-700 border-indigo-200">
                          Bills save: <span className="ml-1 font-semibold">-{currency(w.plannedBillsSaveThisWeek).slice(1)}</span>
                        </Pill>
                        <Pill className="bg-slate-50 text-slate-700 border-slate-200">
                          Expenses: <span className="ml-1 font-semibold">-{currency(w.plannedExpensesThisWeek).slice(1)}</span>
                        </Pill>
                        <Pill className="bg-indigo-50 text-indigo-700 border-indigo-200">
                          Net after: <span className="ml-1 font-semibold">{currency(w.netAfterPlan)}</span>
                        </Pill>
                      </div>
                    </div>

                    <div className="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
                      <div className="p-3 rounded-2xl border border-slate-100 bg-slate-50">
                        <div className="text-xs uppercase tracking-wide text-slate-600 font-semibold">Bills (weekly version)</div>
                        <div className="mt-2 space-y-1 text-sm text-slate-700">
                          <div className="flex justify-between">
                            <span>From paychecks (this week)</span>
                            <span className="font-extrabold text-indigo-700">{currency(w.billsSinkingFundThisWeek)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span>Annual reserve (weekly)</span>
                            <span className="font-extrabold text-indigo-700">{currency(w.annualReserve)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="font-semibold">Total bills to save</span>
                            <span className="font-extrabold text-indigo-900">{currency(w.plannedBillsSaveThisWeek)}</span>
                          </div>
                        </div>
                      </div>

                      <div className="p-3 rounded-2xl border border-slate-100 bg-slate-50">
                        <div className="text-xs uppercase tracking-wide text-slate-600 font-semibold">Expenses (weekly version)</div>
                        <div className="mt-2 space-y-1 text-sm text-slate-700">
                          <div className="flex justify-between">
                            <span>Weekly buckets</span>
                            <span className="font-extrabold">{currency(weeklyBucketTotalOnly)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span>Monthly buckets (split)</span>
                            <span className="font-extrabold">{currency(w.monthlyExpenseSplitThisWeek)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="font-semibold">Total expenses plan</span>
                            <span className="font-extrabold text-slate-800">{currency(w.plannedExpensesThisWeek)}</span>
                          </div>
                        </div>
                        <div className="mt-3 text-xs text-slate-500">
                          Monthly buckets split evenly across {monthWeeksCount} weeks in the selected month.
                        </div>
                      </div>

                      <div className="p-3 rounded-2xl border border-slate-100 bg-slate-50">
                        <div className="text-xs uppercase tracking-wide text-slate-600 font-semibold">Net after plan</div>
                        <div className="mt-2">
                          <div className={`text-3xl font-extrabold ${w.netAfterPlan >= 0 ? "text-emerald-700" : "text-rose-700"}`}>{currency(w.netAfterPlan)}</div>
                          <div className="text-xs text-slate-500 mt-1">Income ‚àí Bills Save ‚àí Expenses Plan</div>
                        </div>
                        <div className="mt-3 text-xs text-slate-500">
                          (Actual spending in this week from transactions: <span className="font-semibold">{currency(w.actualSpent)}</span>)
                        </div>
                      </div>
                    </div>

                    {/* Below: actual bills due + total (requested) */}
                    <div className="mt-4 p-3 rounded-2xl border border-rose-100 bg-rose-50">
                      <div className="flex items-center justify-between">
                        <div className="text-xs uppercase tracking-wide text-rose-700 font-semibold">Actual bills due this week</div>
                        <div className="text-sm font-extrabold text-rose-800">Total: -{currency(w.billsDueThisWeek).slice(1)}</div>
                      </div>

                      <div className="mt-2 space-y-1 text-sm text-rose-900">
                        {w.events.filter(x => x.type === "bill").length === 0 ? (
                          <div className="text-sm text-rose-800/70">No bills scheduled.</div>
                        ) : w.events.filter(x => x.type === "bill").map(ev => (
                          <div key={ev.id} className="flex justify-between">
                            <span><span className="font-semibold">{niceDate(ev.date)}</span> ¬∑ {ev.name}</span>
                            <span className="font-extrabold">-{currency(ev.amount).slice(1)}</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Optional: show income list for the week */}
                    <div className="mt-3 p-3 rounded-2xl border border-emerald-100 bg-emerald-50">
                      <div className="text-xs uppercase tracking-wide text-emerald-700 font-semibold">Income scheduled this week</div>
                      <div className="mt-2 space-y-1 text-sm text-emerald-900">
                        {w.events.filter(x => x.type === "income").length === 0 ? (
                          <div className="text-sm text-emerald-800/70">No income scheduled.</div>
                        ) : w.events.filter(x => x.type === "income").map(ev => (
                          <div key={ev.id} className="flex justify-between">
                            <span><span className="font-semibold">{niceDate(ev.date)}</span> ¬∑ {ev.name}</span>
                            <span className="font-extrabold">{currency(ev.amount)}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </Card>
                ))}
              </section>
            )}

            {/* -------------------- BUCKETS -------------------- */}
            {activeTab === "buckets" && (
              <section className="space-y-4">
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                  {bucketsWithSpent.map((b) => {
                    const pct = b.budgeted > 0 ? Math.min(100, (b.spent / b.budgeted) * 100) : 0;
                    const remaining = round2(b.budgeted - b.spent);
                    const isEditing = editingBucketId === b.id;

                    return (
                      <Card key={b.id} className="p-3 sm:p-4">
                        {!isEditing ? (
                          <>
                            <div className="flex items-center justify-between mb-1">
                              <h3 className="font-semibold text-slate-800">{b.name}</h3>
                              <span className={`text-xs px-2 py-0.5 rounded-full border ${
                                b.period === "weekly" ? "bg-sky-50 text-sky-700 border-sky-200" : "bg-emerald-50 text-emerald-700 border-emerald-200"
                              }`}>
                                {b.period}
                              </span>
                            </div>

                            <div className="flex items-center justify-between text-sm text-slate-600 mb-2">
                              <div>Spent: <span className="font-medium text-slate-800">{currency(b.spent)}</span></div>
                              <div>Budget: <span className="font-medium text-slate-800">{currency(b.budgeted)}</span></div>
                            </div>

                            <div className="w-full bg-slate-100 h-2 rounded overflow-hidden">
                              <div className={`${getProgressColor(b.spent, b.budgeted)} h-2`} style={{ width: `${pct}%` }} />
                            </div>

                            <div className="mt-2 text-sm">
                              <span className={`${remaining >= 0 ? "text-emerald-700" : "text-rose-700"} font-semibold`}>{currency(remaining)}</span>
                              <span className="text-slate-500"> {remaining >= 0 ? "left" : "over"}</span>
                            </div>

                            <div className="mt-3 flex items-center justify-between">
                              <div className="text-xs text-slate-500">
                                Monthly (estimate): <span className="font-semibold text-slate-700">{currency(monthlyFromBudget(b))}</span>
                              </div>
                              <div className="flex gap-2">
                                <button onClick={() => startEditBucket(b)} className={buttonBase + " " + btnSoft}>Edit</button>
                                <button onClick={() => resetBucket(b.id)} className={buttonBase + " bg-sky-100 hover:bg-sky-200 text-sky-700"}>Reset</button>
                                <button onClick={() => deleteBucket(b.id)} className={buttonBase + " " + btnDanger}>Delete</button>
                              </div>
                            </div>
                          </>
                        ) : (
                          <div key={`edit-bucket-${b.id}-${editKey}`}>
                            <div className="font-extrabold text-slate-800">Edit bucket</div>
                            <div className="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
                              <Field label="Name">
                                <input
                                  className={inputBase}
                                  defaultValue={bucketDraftRef.current?.name ?? ""}
                                  onInput={(e) => setRefField(bucketDraftRef, "name", e.target.value)}
                                />
                              </Field>
                              <Field label="Budgeted">
                                <input
                                  type="text"
                                  inputMode="decimal"
                                  placeholder="0.00"
                                  className={moneyInputBase}
                                  defaultValue={bucketDraftRef.current?.budgeted ?? ""}
                                  onInput={(e) => setRefField(bucketDraftRef, "budgeted", e.target.value)}
                                />
                              </Field>
                              <Field label="Period">
                                <select
                                  className={inputBase}
                                  defaultValue={bucketDraftRef.current?.period ?? "monthly"}
                                  onChange={(e) => setRefField(bucketDraftRef, "period", e.target.value)}
                                >
                                  <option value="monthly">Monthly</option>
                                  <option value="weekly">Weekly</option>
                                </select>
                              </Field>
                            </div>
                            <div className="mt-3 flex gap-2 justify-end">
                              <button onClick={cancelEditBucket} className={buttonBase + " " + btnSoft}>Cancel</button>
                              <button onClick={saveEditBucket} className={buttonBase + " " + btnPrimary}>Save</button>
                            </div>
                          </div>
                        )}
                      </Card>
                    );
                  })}
                </div>

                <Card className="p-3 sm:p-4" key={`bucket-form-${bucketFormKey}`}>
                  <h3 className="font-semibold text-slate-800 mb-3">Add Bucket</h3>
                  <form className="grid grid-cols-1 sm:grid-cols-4 gap-3 items-end" onSubmit={(e) => { e.preventDefault(); addBucket(); }}>
                    <Field label="Name">
                      <input
                        className={inputBase}
                        placeholder="Name"
                        defaultValue=""
                        onInput={(e) => setRefField(newBucketRef, "name", e.target.value)}
                      />
                    </Field>
                    <Field label="Amount">
                      <input
                        type="text"
                        inputMode="decimal"
                        placeholder="0.00"
                        className={moneyInputBase}
                        defaultValue=""
                        onInput={(e) => setRefField(newBucketRef, "budgeted", e.target.value)}
                      />
                    </Field>
                    <Field label="Period">
                      <select
                        className={inputBase}
                        defaultValue="monthly"
                        onChange={(e) => setRefField(newBucketRef, "period", e.target.value)}
                      >
                        <option value="monthly">Monthly</option>
                        <option value="weekly">Weekly</option>
                      </select>
                    </Field>
                    <button type="submit" className={buttonBase + " " + btnPrimary + " w-full"}>Add</button>
                  </form>
                </Card>
              </section>
            )}

            {/* -------------------- INCOME -------------------- */}
            {activeTab === "income" && (
              <section className="space-y-4">
                <Card className="p-3 sm:p-4">
                  <h3 className="font-semibold text-slate-800 mb-3">Income</h3>
                  <div className="space-y-3">
                    {recurringIncome
                      .slice()
                      .sort((a,b) => (String(nextSingleDueDate(a)) > String(nextSingleDueDate(b)) ? 1 : -1))
                      .map((i) => {
                        const isEditing = editingIncomeId === i.id;
                        return (
                          <div key={i.id} className="p-3 rounded-xl border border-slate-100 bg-slate-50">
                            {!isEditing ? (
                              <div className="flex items-center justify-between gap-3">
                                <div className="min-w-0">
                                  <div className="font-semibold text-slate-800 flex items-center gap-2 flex-wrap">
                                    <span className="truncate">{i.name}</span>
                                    {isMissingAnchorIncome(i) && <WarnPill text="Missing anchor date" />}
                                    {isMissingDateOnceIncome(i) && <WarnPill text="Missing date" />}
                                    <span className="text-slate-500 font-normal">¬∑ {currency(i.amount)}</span>
                                  </div>
                                  <div className="text-xs text-slate-500">
                                    {i.frequency === "once"
                                      ? <>one-time ¬∑ On: <span className="font-medium text-slate-700">{i.nextDate || "‚Äî"}</span></>
                                      : <>{i.frequency} ¬∑ Next: <span className="font-medium text-slate-700">{nextSingleDueDate(i)}</span></>
                                    }
                                  </div>
                                </div>
                                <div className="flex gap-2 shrink-0">
                                  <button onClick={() => startEditIncome(i)} className={buttonBase + " " + btnSoft}>Edit</button>
                                  <button onClick={() => deleteIncome(i.id)} className={buttonBase + " " + btnDanger}>Delete</button>
                                </div>
                              </div>
                            ) : (
                              <div key={`edit-income-${i.id}-${editKey}`}>
                                <div className="font-extrabold text-slate-800">Edit income</div>
                                <div className="mt-3 grid grid-cols-1 sm:grid-cols-4 gap-3">
                                  <Field label="Name">
                                    <input
                                      className={inputBase}
                                      defaultValue={incomeDraftRef.current?.name ?? ""}
                                      onInput={(e)=>setRefField(incomeDraftRef,"name",e.target.value)}
                                    />
                                  </Field>
                                  <Field label="Amount">
                                    <input
                                      type="text"
                                      inputMode="decimal"
                                      placeholder="0.00"
                                      className={moneyInputBase}
                                      defaultValue={incomeDraftRef.current?.amount ?? ""}
                                      onInput={(e)=>setRefField(incomeDraftRef,"amount",e.target.value)}
                                    />
                                  </Field>
                                  <Field label="Frequency">
                                    <select
                                      className={inputBase}
                                      defaultValue={incomeDraftRef.current?.frequency ?? "monthly"}
                                      onChange={(e)=>setRefField(incomeDraftRef,"frequency",e.target.value)}
                                    >
                                      <option value="monthly">Monthly</option>
                                      <option value="weekly">Weekly</option>
                                      <option value="biweekly">Bi-weekly</option>
                                      <option value="once">One-time</option>
                                    </select>
                                  </Field>
                                  <Field label={(incomeDraftRef.current?.frequency === "once") ? "Date" : "Anchor / Next Date"}>
                                    <input
                                      type="date"
                                      className={inputBase}
                                      defaultValue={incomeDraftRef.current?.nextDate ?? ""}
                                      onChange={(e)=>setRefField(incomeDraftRef,"nextDate",e.target.value)}
                                    />
                                  </Field>
                                </div>
                                <div className="mt-3 flex gap-2 justify-end">
                                  <button onClick={cancelEditIncome} className={buttonBase + " " + btnSoft}>Cancel</button>
                                  <button onClick={saveEditIncome} className={buttonBase + " " + btnPrimary}>Save</button>
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                  </div>
                </Card>

                <Card className="p-3 sm:p-4" key={`income-form-${incomeFormKey}`}>
                  <h3 className="font-semibold text-slate-800 mb-3">Add Income</h3>
                  <form className="grid grid-cols-1 sm:grid-cols-5 gap-3 items-end" onSubmit={(e) => { e.preventDefault(); addIncome(); }}>
                    <Field label="Name">
                      <input className={inputBase} defaultValue="" onInput={(e)=>setRefField(newIncomeRef,"name",e.target.value)} />
                    </Field>
                    <Field label="Amount">
                      <input type="text" inputMode="decimal" placeholder="0.00" className={moneyInputBase} defaultValue=""
                        onInput={(e)=>setRefField(newIncomeRef,"amount",e.target.value)} />
                    </Field>
                    <Field label="Frequency">
                      <select className={inputBase} defaultValue="monthly" onChange={(e)=>setRefField(newIncomeRef,"frequency",e.target.value)}>
                        <option value="monthly">Monthly</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="once">One-time</option>
                      </select>
                    </Field>
                    <Field label="Date / Anchor">
                      <input type="date" className={inputBase} defaultValue="" onChange={(e)=>setRefField(newIncomeRef,"nextDate",e.target.value)} />
                    </Field>
                    <button type="submit" className={buttonBase + " " + btnPrimary + " w-full"}>Add</button>
                  </form>
                </Card>
              </section>
            )}

            {/* -------------------- BILLS -------------------- */}
            {activeTab === "bills" && (
              <section className="space-y-4">
                <Card className="p-3 sm:p-4">
                  <h3 className="font-semibold text-slate-800 mb-3">Bills</h3>
                  <div className="space-y-3">
                    {recurringBills
                      .slice()
                      .sort((a, b) => (String(nextSingleDueDate(a)) > String(nextSingleDueDate(b)) ? 1 : -1))
                      .map((b) => {
                        const isEditing = editingBillId === b.id;
                        return (
                          <div key={b.id} className="p-3 rounded-xl border border-slate-100 bg-slate-50">
                            {!isEditing ? (
                              <div className="flex items-center justify-between gap-3">
                                <div className="min-w-0">
                                  <div className="font-semibold text-slate-800 flex items-center gap-2 flex-wrap">
                                    <span className="truncate">{b.name}</span>
                                    {isMissingAnchorBill(b) && <WarnPill text="Missing anchor date" />}
                                    <span className="text-slate-500 font-normal">¬∑ {currency(b.amount)}</span>
                                  </div>
                                  <div className="text-xs text-slate-500">
                                    {b.frequency} ¬∑ Next: <span className="font-medium text-slate-700">{nextSingleDueDate(b)}</span>
                                  </div>
                                </div>
                                <div className="flex gap-2 shrink-0">
                                  <button onClick={() => startEditBill(b)} className={buttonBase + " " + btnSoft}>Edit</button>
                                  <button onClick={() => deleteBill(b.id)} className={buttonBase + " " + btnDanger}>Delete</button>
                                </div>
                              </div>
                            ) : (
                              <div key={`edit-bill-${b.id}-${editKey}`}>
                                <div className="font-extrabold text-slate-800">Edit bill</div>
                                <div className="mt-3 grid grid-cols-1 sm:grid-cols-4 gap-3">
                                  <Field label="Name">
                                    <input className={inputBase} defaultValue={billDraftRef.current?.name ?? ""} onInput={(e)=>setRefField(billDraftRef,"name",e.target.value)} />
                                  </Field>
                                  <Field label="Amount">
                                    <input type="text" inputMode="decimal" placeholder="0.00" className={moneyInputBase}
                                      defaultValue={billDraftRef.current?.amount ?? ""} onInput={(e)=>setRefField(billDraftRef,"amount",e.target.value)} />
                                  </Field>
                                  <Field label="Frequency">
                                    <select className={inputBase} defaultValue={billDraftRef.current?.frequency ?? "monthly"} onChange={(e)=>setRefField(billDraftRef,"frequency",e.target.value)}>
                                      <option value="monthly">Monthly</option>
                                      <option value="weekly">Weekly</option>
                                      <option value="yearly">Yearly</option>
                                    </select>
                                  </Field>

                                  {(billDraftRef.current?.frequency ?? "monthly") === "monthly" && (
                                    <Field label="Due day (1-28)">
                                      <input type="number" className={inputBase} defaultValue={billDraftRef.current?.dueDay ?? ""} onInput={(e)=>setRefField(billDraftRef,"dueDay",e.target.value)} />
                                    </Field>
                                  )}

                                  {(billDraftRef.current?.frequency ?? "monthly") === "weekly" && (
                                    <Field label="Anchor date">
                                      <input type="date" className={inputBase} defaultValue={billDraftRef.current?.nextDate ?? ""} onChange={(e)=>setRefField(billDraftRef,"nextDate",e.target.value)} />
                                    </Field>
                                  )}

                                  {(billDraftRef.current?.frequency ?? "monthly") === "yearly" && (
                                    <>
                                      <Field label="Due month (1-12)">
                                        <input type="number" className={inputBase} defaultValue={billDraftRef.current?.dueMonth ?? ""} onInput={(e)=>setRefField(billDraftRef,"dueMonth",e.target.value)} />
                                      </Field>
                                      <Field label="Due day (1-28)">
                                        <input type="number" className={inputBase} defaultValue={billDraftRef.current?.dueDay ?? ""} onInput={(e)=>setRefField(billDraftRef,"dueDay",e.target.value)} />
                                      </Field>
                                    </>
                                  )}
                                </div>

                                {(billDraftRef.current?.frequency === "weekly") && !parseYMDLocal(billDraftRef.current?.nextDate) && (
                                  <div className="mt-2 text-xs text-amber-800">‚ö†Ô∏è Weekly bills need an anchor date.</div>
                                )}

                                <div className="mt-3 flex gap-2 justify-end">
                                  <button onClick={cancelEditBill} className={buttonBase + " " + btnSoft}>Cancel</button>
                                  <button onClick={saveEditBill} className={buttonBase + " " + btnPrimary}>Save</button>
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                  </div>
                </Card>

                <Card className="p-3 sm:p-4" key={`bill-form-${billFormKey}`}>
                  <h3 className="font-semibold text-slate-800 mb-3">Add Bill</h3>
                  <form className="grid grid-cols-1 sm:grid-cols-5 gap-3 items-end" onSubmit={(e) => { e.preventDefault(); addBill(); }}>
                    <Field label="Name">
                      <input className={inputBase} defaultValue="" onInput={(e)=>setRefField(newBillRef,"name",e.target.value)} />
                    </Field>
                    <Field label="Amount">
                      <input type="text" inputMode="decimal" placeholder="0.00" className={moneyInputBase} defaultValue=""
                        onInput={(e)=>setRefField(newBillRef,"amount",e.target.value)} />
                    </Field>
                    <Field label="Frequency">
                      <select className={inputBase} defaultValue="monthly" onChange={(e)=>setRefField(newBillRef,"frequency",e.target.value)}>
                        <option value="monthly">Monthly</option>
                        <option value="weekly">Weekly</option>
                        <option value="yearly">Yearly</option>
                      </select>
                    </Field>

                    <Field label="Due day (or anchor)">
                      <input className={inputBase} placeholder="Monthly due day / Yearly due day" defaultValue=""
                        onInput={(e)=>setRefField(newBillRef,"dueDay",e.target.value)} />
                    </Field>

                    <Field label="Due month / Anchor date">
                      <input className={inputBase} placeholder="Yearly due month OR weekly YYYY-MM-DD" defaultValue=""
                        onInput={(e)=> {
                          const v = e.target.value;
                          if (/^\d{4}-\d{2}-\d{2}$/.test(v)) setRefField(newBillRef,"nextDate",v);
                          else setRefField(newBillRef,"dueMonth",v);
                        }} />
                    </Field>

                    <button type="submit" className={buttonBase + " " + btnPrimary + " w-full"}>Add</button>
                  </form>

                  {newBillRef.current?.frequency === "weekly" && !parseYMDLocal(newBillRef.current?.nextDate) && (
                    <div className="mt-2 text-xs text-amber-800">‚ö†Ô∏è Weekly bills need an anchor date (YYYY-MM-DD in the last field).</div>
                  )}
                </Card>
              </section>
            )}

            {/* -------------------- TRANSACTIONS -------------------- */}
            {activeTab === "transactions" && (
              <section className="space-y-4">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <Card className="p-3 sm:p-4">
                    <h3 className="font-semibold text-slate-800 mb-3">Transactions</h3>
                    <div className="space-y-3">
                      {transactions
                        .slice()
                        .sort((a, b) => (a.date < b.date ? 1 : -1))
                        .map((t) => {
                          const bucketName = buckets.find(b => b.id === t.bucketId)?.name || "Unknown";
                          return (
                            <div key={t.id} className="flex items-center justify-between p-3 rounded border border-slate-100 bg-slate-50">
                              <div>
                                <div className="font-medium text-slate-800">{t.description} <span className="text-slate-500 font-normal">¬∑ {currency(t.amount)}</span></div>
                                <div className="text-xs text-slate-500">{t.date} ¬∑ {bucketName}</div>
                              </div>
                              <button onClick={() => deleteTransaction(t.id)} className={buttonBase + " " + btnDanger}>Delete</button>
                            </div>
                          );
                        })}
                    </div>
                  </Card>

                  <Card className="p-3 sm:p-4" key={`tx-form-${txFormKey}`}>
                    <h3 className="font-semibold text-slate-800 mb-3">Add Transaction</h3>
                    <form className="grid grid-cols-1 sm:grid-cols-5 gap-3 items-end" onSubmit={(e) => { e.preventDefault(); addTransaction(); }}>
                      <Field label="Bucket">
                        <select className={inputBase} defaultValue="" onChange={(e)=>setRefField(newTxRef,"bucketId",e.target.value)}>
                          <option value="">Select Bucket</option>
                          {buckets.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                        </select>
                      </Field>
                      <Field label="Amount">
                        <input type="text" inputMode="decimal" placeholder="0.00" className={moneyInputBase} defaultValue=""
                          onInput={(e)=>setRefField(newTxRef,"amount",e.target.value)} />
                      </Field>
                      <Field label="Description">
                        <input className={inputBase} defaultValue="" onInput={(e)=>setRefField(newTxRef,"description",e.target.value)} />
                      </Field>
                      <Field label="Date">
                        <input type="date" className={inputBase} defaultValue={todayStr} onChange={(e)=>setRefField(newTxRef,"date",e.target.value)} />
                      </Field>
                      <button type="submit" className={buttonBase + " " + btnPrimary + " w-full"}>Add</button>
                    </form>
                  </Card>
                </div>
              </section>
            )}

          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
